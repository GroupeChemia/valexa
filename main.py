from valexa.profiles import ProfileManager
from valexa.examples.dataset import sample_dataset
from plotly.utils import PlotlyJSONEncoder
import pandas as pd
import valexa.helper as vx
import numpy as np
import json


dataset = {
    "Validation": pd.DataFrame(
        [
            [2, 1, 419, 1.53451784646202],
            [3, 1, 443, 1.58609969980414],
            [2, 1, 419, 1.45862500900871],
            [3, 1, 443, 1.57630090218957],
            [2, 1, 419, 1.55035399412083],
            [3, 1, 443, 1.60626322138179],
            [1, 2, 1015, 3.91003892419292],
            [2, 2, 1047.5, 4.4144308245623],
            [3, 2, 1107.5, 4.84901802102159],
            [1, 2, 1015, 3.98691721426075],
            [2, 2, 1047.5, 4.25259486021748],
            [3, 2, 1107.5, 4.95757568303534],
            [1, 2, 1015, 3.99524580443895],
            [2, 2, 1047.5, 4.43489882448232],
            [3, 2, 1107.5, 5.03027363667067],
            [1, 4, 3045, 11.9111186706619],
            [2, 4, 3142.5, 12.4307010001949],
            [3, 4, 3322.5, 14.3365673436486],
            [1, 4, 3045, 12.0129540993486],
            [2, 4, 3142.5, 12.0058639937357],
            [3, 4, 3322.5, 14.4587582849768],
            [1, 4, 3045, 12.0860185183728],
            [2, 4, 3142.5, 12.1419565482177],
            [3, 4, 3322.5, 14.5641280564365],
            [1, 5, 4060, 14.239666251549],
            [2, 5, 4190, 17.2338229373495],
            [3, 5, 4430, 18.3592301237821],
            [1, 5, 4060, 14.382300001946],
            [2, 5, 4190, 16.6125112965469],
            [3, 5, 4430, 18.3304205458616],
            [1, 5, 4060, 14.3762852569976],
            [2, 5, 4190, 16.8719649174288],
            [3, 5, 4430, 18.6730754223547],

        ],
        columns=["Series", "Level", "x", "y"],
    ),
    "Calibration": pd.DataFrame(
        [
            [1, 1, 406, 0.998586158821292],
            [2, 1, 419, 1.10404061555999],
            [3, 1, 443, 1.33676184474706],
            [1, 1, 406, 1.10668672019367],
            [2, 1, 419, 1.10533409837239],
            [3, 1, 443, 1.3452641016464],
            [1, 1, 406, 1.11747929869418],
            [2, 1, 419, 1.11881371928904],
            [3, 1, 443, 1.33976563224466],
            [1, 2, 1015, 4.17857258377101],
            [2, 2, 1047.5, 4.46274945189253],
            [3, 2, 1107.5, 4.62794228756877],
            [1, 2, 1015, 4.50347521387168],
            [2, 2, 1047.5, 4.37069789781473],
            [3, 2, 1107.5, 4.67589704309223],
            [1, 2, 1015, 4.48445208560007],
            [2, 2, 1047.5, 4.37276385650597],
            [3, 2, 1107.5, 4.71876455317858],
            [1, 3, 2030, 6.64220182668196],
            [2, 3, 2095, 9.02599522367508],
            [3, 3, 2215, 9.86865872842256],
            [1, 3, 2030, 7.27105908029828],
            [2, 3, 2095, 9.02019877671338],
            [3, 3, 2215, 9.98849560427756],
            [1, 3, 2030, 7.48971950689836],
            [2, 3, 2095, 9.21288759522981],
            [3, 3, 2215, 10.1085590484058],
            [1, 4, 3045, 12.3754474804587],
            [2, 4, 3142.5, 11.6258656940642],
            [3, 4, 3322.5, 14.9180354705792],
            [1, 4, 3045, 12.8790473560492],
            [2, 4, 3142.5, 11.758352792905],
            [3, 4, 3322.5, 15.233986963097],
            [1, 4, 3045, 13.4446593846229],
            [2, 4, 3142.5, 11.8714051364981],
            [3, 4, 3322.5, 15.2766192141471],
            [1, 5, 4060, 14.7498947045687],
            [2, 5, 4190, 15.4064327172843],
            [3, 5, 4430, 20.176000755941],
            [1, 5, 4060, 15.8888569932834],
            [2, 5, 4190, 15.4200260630323],
            [3, 5, 4430, 20.8796730188044],
            [1, 5, 4060, 16.2515119657081],
            [2, 5, 4190, 15.1633049451082],
            [3, 5, 4430, 21.1905995597224],
        ],
        columns=["Series", "Level", "x", "y"],
    )
}

def main():
    """
    Dataset from:
    inra_pyrene: Huyez-Levrat, M et al.,Cahier technique de l'INRA - Validation des m√©thodes (2010), https://www6.inrae.fr/cahier_des_techniques/Les-Cahiers-parus/Les-n-Speciaux-et-les-n-Thematiques/Validation-des-methodes

    This dataset is mainly use to check if the correction factor generated is 1.2.
    The
    :return:
    """

    optimizer_parameter = {
        "has_limits": True,
        "validation_range": "max",
        "average.bias_abs": "min",
        "min_loq": "min",
        "model.rsquared": "max",
    }
    validation = dataset['Validation'].sort_values(by='x')
    calibration = dataset['Calibration'].sort_values(by='x')

    dataset['Validation'] = validation
    dataset['Calibration'] = calibration
    data = dataset


    # config = {
    #     "compound_name": "Test",
    #     "rolling_data": False,
    #     "optimizer_parameter": optimizer_parameter,
    #     "correction_allow": True,
    #     "model_to_test": ['Linear'],
    #     "data": data,
    #     "rolling_limit": 3,
    #     "significant_figure": 4,
    # }

    config = json.loads('{"compound_name":"Bifenthrin HPLC   - 21A13 -","data":{"validation":[{"series":1,"level":1,"x1":0.8,"y1":184.617595492307,"y2":167.359280496552,"y3":157.156250072703},{"series":1,"level":2,"x1":1,"y1":263.227000125724,"y2":288.209830147047,"y3":287.822624518707},{"series":1,"level":3,"x1":1.1999999999999997,"y1":257.569567725523,"y2":244.435940135389,"y3":254.737802356131},{"series":2,"level":1,"x1":0.8,"y1":106.543879499434,"y2":90.7213904390424,"y3":95.4645032971028},{"series":2,"level":2,"x1":1,"y1":95.5546855506995,"y2":97.5785830824689,"y3":80.3339986953091},{"series":2,"level":3,"x1":1.1999999999999997,"y1":147.870751919989,"y2":181.880294225037,"y3":170.860299753107},{"series":3,"level":1,"x1":0.8,"y1":99.3565119346372,"y2":96.6514996967079,"y3":95.2922468563818},{"series":3,"level":2,"x1":1,"y1":78.2792276258038,"y2":129.246096165145,"y3":105.681071544329},{"series":3,"level":3,"x1":1.1999999999999997,"y1":105.151456606162,"y2":156.135316083639,"y3":114.609185204173},{"series":4,"level":1,"x1":0.8,"y1":177.607747610597,"y2":167.934558480591,"y3":169.932670205213},{"series":4,"level":2,"x1":1,"y1":182.861818702173,"y2":194.978968956159,"y3":156.090207166569},{"series":4,"level":3,"x1":1.1999999999999997,"y1":250.144980529773,"y2":224.464582224855,"y3":257.352656177218},{"series":5,"level":1,"x1":0.8,"y1":149.091976681631,"y2":141.172638294307,"y3":146.753234306094},{"series":5,"level":2,"x1":1,"y1":189.679452516714,"y2":200.825796144233,"y3":214.455825883216},{"series":5,"level":3,"x1":1.1999999999999997,"y1":213.491696530635,"y2":201.726324926397,"y3":200.513886449951},{"series":6,"level":1,"x1":0.8,"y1":124.268962191664,"y2":111.421581372365,"y3":112.436867145784},{"series":6,"level":2,"x1":1,"y1":145.173786664158,"y2":151.652695624763,"y3":139.561230886976},{"series":6,"level":3,"x1":1.1999999999999997,"y1":168.828670247212,"y2":162.716876363747,"y3":168.21682892409}],"calibration":[{"series":1,"level":1,"x1":0.6,"y1":1907.2336061689848},{"series":1,"level":2,"x1":1,"y1":3342.97519454872},{"series":1,"level":3,"x1":1.4999999999999998,"y1":5022.3876954722},{"series":1,"level":4,"x1":2,"y1":6684.59077889063},{"series":1,"level":5,"x1":4,"y1":13096.73932537265},{"series":2,"level":1,"x1":0.6,"y1":4714.530537339956},{"series":2,"level":2,"x1":1,"y1":8443.70543125037},{"series":2,"level":3,"x1":1.4999999999999998,"y1":12373.821419117567},{"series":2,"level":4,"x1":2,"y1":15949.360148428867},{"series":2,"level":5,"x1":4,"y1":29547.383420106737},{"series":3,"level":1,"x1":0.6,"y1":2761.4689406404364},{"series":3,"level":2,"x1":1,"y1":7005.846296000257},{"series":3,"level":3,"x1":1.4999999999999998,"y1":10243.8702776888},{"series":3,"level":4,"x1":2,"y1":12504.4768106633},{"series":3,"level":5,"x1":4,"y1":24252.78687355223},{"series":4,"level":1,"x1":0.2,"y1":1139.32473206266},{"series":4,"level":2,"x1":0.4,"y1":2132.733318455717},{"series":4,"level":3,"x1":1,"y1":5800.431580856133},{"series":4,"level":4,"x1":1.4999999999999998,"y1":8580.154828779678},{"series":4,"level":5,"x1":2,"y1":11939.307018978565},{"series":5,"level":1,"x1":0.2,"y1":1139.32473206266},{"series":5,"level":2,"x1":0.4,"y1":2132.733318455717},{"series":5,"level":3,"x1":1,"y1":5800.431580856133},{"series":5,"level":4,"x1":1.4999999999999998,"y1":8580.154828779678},{"series":5,"level":5,"x1":2,"y1":11939.307018978565},{"series":6,"level":1,"x1":0.2,"y1":788.393759346972},{"series":6,"level":2,"x1":0.4,"y1":1714.18998190332},{"series":6,"level":3,"x1":1,"y1":4402.09301865278},{"series":6,"level":4,"x1":1.4999999999999998,"y1":6551.76725366624},{"series":6,"level":5,"x1":2,"y1":8847.4653110557}]},"tolerance_limit":80,"acceptance_limit":50,"acceptance_absolute":false,"quantity_units":"ppm","rolling_data":false,"rolling_limit":3,"model_to_test":"Linear","correction_allow":true,"correction_threshold":[0.9,1.1],"correction_forced_value":null,"correction_type":"slope","correction_round_to":2,"optimizer_parameter":null,"significant_figure":4,"lod_allowed":null,"lod_force_miller":false,"data_transformation":null,"use_median":false,"status":""}')
    config['data'] = vx.format_json_to_data(config['data'])
    config['correction_type'] = 'average'
    # config['correction_allow'] = True
    # config['correction_forced_value'] = None
    # config['acceptance_absolute'] = True

    profiles = ProfileManager(**config)
    profiles.make_profiles()
    # profiles.optimize()


    aa = profiles.output_profiles()

    for zz in aa.values():
        print(json.dumps({"type": "PROFILE", "data": zz}, cls=PlotlyJSONEncoder))

    profiles.optimize()

    pass

if __name__ == "__main__":
    main()

