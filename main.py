from valexa.profiles import ProfileManager
from valexa.examples.dataset import sample_dataset
from plotly.utils import PlotlyJSONEncoder
import pandas as pd
import valexa.helper as vx
import numpy as np
import json


dataset = {
    "Validation": pd.DataFrame(
        [
            [2, 1, 419, 1.53451784646202],
            [3, 1, 443, 1.58609969980414],
            [2, 1, 419, 1.45862500900871],
            [3, 1, 443, 1.57630090218957],
            [2, 1, 419, 1.55035399412083],
            [3, 1, 443, 1.60626322138179],
            [1, 2, 1015, 3.91003892419292],
            [2, 2, 1047.5, 4.4144308245623],
            [3, 2, 1107.5, 4.84901802102159],
            [1, 2, 1015, 3.98691721426075],
            [2, 2, 1047.5, 4.25259486021748],
            [3, 2, 1107.5, 4.95757568303534],
            [1, 2, 1015, 3.99524580443895],
            [2, 2, 1047.5, 4.43489882448232],
            [3, 2, 1107.5, 5.03027363667067],
            [1, 4, 3045, 11.9111186706619],
            [2, 4, 3142.5, 12.4307010001949],
            [3, 4, 3322.5, 14.3365673436486],
            [1, 4, 3045, 12.0129540993486],
            [2, 4, 3142.5, 12.0058639937357],
            [3, 4, 3322.5, 14.4587582849768],
            [1, 4, 3045, 12.0860185183728],
            [2, 4, 3142.5, 12.1419565482177],
            [3, 4, 3322.5, 14.5641280564365],
            [1, 5, 4060, 14.239666251549],
            [2, 5, 4190, 17.2338229373495],
            [3, 5, 4430, 18.3592301237821],
            [1, 5, 4060, 14.382300001946],
            [2, 5, 4190, 16.6125112965469],
            [3, 5, 4430, 18.3304205458616],
            [1, 5, 4060, 14.3762852569976],
            [2, 5, 4190, 16.8719649174288],
            [3, 5, 4430, 18.6730754223547],

        ],
        columns=["Series", "Level", "x", "y"],
    ),
    "Calibration": pd.DataFrame(
        [
            [1, 1, 406, 0.998586158821292],
            [2, 1, 419, 1.10404061555999],
            [3, 1, 443, 1.33676184474706],
            [1, 1, 406, 1.10668672019367],
            [2, 1, 419, 1.10533409837239],
            [3, 1, 443, 1.3452641016464],
            [1, 1, 406, 1.11747929869418],
            [2, 1, 419, 1.11881371928904],
            [3, 1, 443, 1.33976563224466],
            [1, 2, 1015, 4.17857258377101],
            [2, 2, 1047.5, 4.46274945189253],
            [3, 2, 1107.5, 4.62794228756877],
            [1, 2, 1015, 4.50347521387168],
            [2, 2, 1047.5, 4.37069789781473],
            [3, 2, 1107.5, 4.67589704309223],
            [1, 2, 1015, 4.48445208560007],
            [2, 2, 1047.5, 4.37276385650597],
            [3, 2, 1107.5, 4.71876455317858],
            [1, 3, 2030, 6.64220182668196],
            [2, 3, 2095, 9.02599522367508],
            [3, 3, 2215, 9.86865872842256],
            [1, 3, 2030, 7.27105908029828],
            [2, 3, 2095, 9.02019877671338],
            [3, 3, 2215, 9.98849560427756],
            [1, 3, 2030, 7.48971950689836],
            [2, 3, 2095, 9.21288759522981],
            [3, 3, 2215, 10.1085590484058],
            [1, 4, 3045, 12.3754474804587],
            [2, 4, 3142.5, 11.6258656940642],
            [3, 4, 3322.5, 14.9180354705792],
            [1, 4, 3045, 12.8790473560492],
            [2, 4, 3142.5, 11.758352792905],
            [3, 4, 3322.5, 15.233986963097],
            [1, 4, 3045, 13.4446593846229],
            [2, 4, 3142.5, 11.8714051364981],
            [3, 4, 3322.5, 15.2766192141471],
            [1, 5, 4060, 14.7498947045687],
            [2, 5, 4190, 15.4064327172843],
            [3, 5, 4430, 20.176000755941],
            [1, 5, 4060, 15.8888569932834],
            [2, 5, 4190, 15.4200260630323],
            [3, 5, 4430, 20.8796730188044],
            [1, 5, 4060, 16.2515119657081],
            [2, 5, 4190, 15.1633049451082],
            [3, 5, 4430, 21.1905995597224],
        ],
        columns=["Series", "Level", "x", "y"],
    )
}

def main():
    """
    Dataset from:
    inra_pyrene: Huyez-Levrat, M et al.,Cahier technique de l'INRA - Validation des m√©thodes (2010), https://www6.inrae.fr/cahier_des_techniques/Les-Cahiers-parus/Les-n-Speciaux-et-les-n-Thematiques/Validation-des-methodes

    This dataset is mainly use to check if the correction factor generated is 1.2.
    The
    :return:
    """

    optimizer_parameter = {
        "has_limits": True,
        "validation_range": "max",
        "average.bias_abs": "min",
        "min_loq": "min",
        "model.rsquared": "max",
    }
    validation = dataset['Validation'].sort_values(by='x')
    calibration = dataset['Calibration'].sort_values(by='x')

    dataset['Validation'] = validation
    dataset['Calibration'] = calibration
    data = dataset


    # config = {
    #     "compound_name": "Test",
    #     "rolling_data": False,
    #     "optimizer_parameter": optimizer_parameter,
    #     "correction_allow": True,
    #     "model_to_test": ['Linear'],
    #     "data": data,
    #     "rolling_limit": 3,
    #     "significant_figure": 4,
    # }

    config = json.loads('{"compound_name":"21A13 - Acetamiprid (1)","data":{"validation":[{"series":1,"level":1,"x1":0.11999999999999998,"y1":31625.7826059639,"y2":30630.7368445545,"y3":31758.842140283,"$id":"75462666-0000000"},{"series":1,"level":2,"x1":0.1,"y1":26459.3750390292,"y2":27207.4115607666,"y3":26672.3303820426,"$id":"75462666-0000001"},{"series":1,"level":3,"x1":0.08,"y1":21059.8106651084,"y2":21459.5644407333,"y3":21026.8109976822,"$id":"75462666-0000002"},{"series":2,"level":1,"x1":0.11999999999999998,"y1":29997.2147128067,"y2":30084.8083347603,"y3":30376.923330993,"$id":"75462666-0000003"},{"series":2,"level":2,"x1":0.1,"y1":23640.3011726193,"y2":23964.9346143238,"y3":23941.9838396576,"$id":"75462666-0000004"},{"series":2,"level":3,"x1":0.08,"y1":20112.2822046466,"y2":19629.5706524873,"y3":19366.2214827168,"$id":"75462666-0000005"},{"series":3,"level":1,"x1":0.11999999999999998,"y1":30314.4459521185,"y2":30235.5055006842,"y3":30050.6260120754,"$id":"75462666-0000006"},{"series":3,"level":2,"x1":0.1,"y1":25261.9443208121,"y2":25340.0222686186,"y3":25907.5676562924,"$id":"75462666-0000007"},{"series":3,"level":3,"x1":0.08,"y1":21021.1702045855,"y2":20521.0134870817,"y3":20304.2491923646,"$id":"75462666-0000008"},{"series":4,"level":1,"x1":0.11999999999999998,"y1":36048.9675140727,"y2":36572.6653636176,"y3":36774.8725442533,"$id":"75462666-0000009"},{"series":4,"level":2,"x1":0.1,"y1":29727.2291214916,"y2":29584.2379969168,"y3":29643.7307662062,"$id":"75462666-0000010"},{"series":4,"level":3,"x1":0.08,"y1":23786.8924262049,"y2":24688.3491214959,"y3":24471.0449642119,"$id":"75462666-0000011"},{"series":5,"level":1,"x1":0.11999999999999998,"y1":36685.0423038524,"y2":36202.9822409836,"y3":36301.9708987538,"$id":"75462666-0000012"},{"series":5,"level":2,"x1":0.1,"y1":30758.1757356991,"y2":30761.7071238574,"y3":30752.197707862,"$id":"75462666-0000013"},{"series":5,"level":3,"x1":0.08,"y1":23320.4011231133,"y2":23715.5353237838,"y3":23575.0614149205,"$id":"75462666-0000014"},{"series":6,"level":1,"x1":0.11999999999999998,"y1":32376.5334453119,"y2":32261.4347838131,"y3":32693.1181466779,"$id":"75462666-0000015"},{"series":6,"level":2,"x1":0.1,"y1":26781.6087754861,"y2":27189.6788996939,"y3":26933.0495442519,"$id":"75462666-0000016"},{"series":6,"level":3,"x1":0.08,"y1":21601.9997433334,"y2":21531.4862999736,"y3":22014.6432131077,"$id":"75462666-0000017"}],"calibration":[{"series":1,"level":1,"x1":0.4,"y1":100300.62282462,"$id":"75462693-0000000"},{"series":1,"level":2,"x1":0.2,"y1":49927.6295209558,"$id":"75462693-0000001"},{"series":1,"level":3,"x1":0.15,"y1":36026.4271796947,"$id":"75462693-0000002"},{"series":1,"level":4,"x1":0.1,"y1":24429.7356284411,"$id":"75462693-0000003"},{"series":1,"level":5,"x1":0.06,"y1":13145.1812499004,"$id":"75462693-0000004"},{"series":2,"level":1,"x1":0.4,"y1":109210.964370388,"$id":"75462693-0000005"},{"series":2,"level":2,"x1":0.2,"y1":54118.2002901088,"$id":"75462693-0000006"},{"series":2,"level":3,"x1":0.15,"y1":39627.6786787585,"$id":"75462693-0000007"},{"series":2,"level":4,"x1":0.1,"y1":25968.0979833636,"$id":"75462693-0000008"},{"series":2,"level":5,"x1":0.06,"y1":14284.0048693309,"$id":"75462693-0000009"},{"series":3,"level":1,"x1":0.4,"y1":128018.257887935,"$id":"75462693-0000010"},{"series":3,"level":2,"x1":0.2,"y1":63168.2225637223,"$id":"75462693-0000011"},{"series":3,"level":3,"x1":0.15,"y1":47196.7915954787,"$id":"75462693-0000012"},{"series":3,"level":4,"x1":0.1,"y1":31120.5611655086,"$id":"75462693-0000013"},{"series":3,"level":5,"x1":0.06,"y1":12106.8655499197,"$id":"75462693-0000014"},{"series":4,"level":1,"x1":0.2,"y1":60397.4679254711,"$id":"75462693-0000015"},{"series":4,"level":2,"x1":0.15,"y1":42450.0265845124,"$id":"75462693-0000016"},{"series":4,"level":3,"x1":0.1,"y1":28138.8636761288,"$id":"75462693-0000017"},{"series":4,"level":4,"x1":0.04,"y1":10691.222526181,"$id":"75462693-0000018"},{"series":4,"level":5,"x1":0.02,"y1":5448.15371224878,"$id":"75462693-0000019"},{"series":5,"level":1,"x1":0.2,"y1":60397.4679254711,"$id":"75462693-0000020"},{"series":5,"level":2,"x1":0.15,"y1":42450.0265845124,"$id":"75462693-0000021"},{"series":5,"level":3,"x1":0.1,"y1":28138.8636761288,"$id":"75462693-0000022"},{"series":5,"level":4,"x1":0.04,"y1":10691.222526181,"$id":"75462693-0000023"},{"series":5,"level":5,"x1":0.02,"y1":5448.15371224878,"$id":"75462693-0000024"},{"series":6,"level":1,"x1":0.2,"y1":56716.4674695382,"$id":"75462693-0000025"},{"series":6,"level":2,"x1":0.15,"y1":40214.3162896031,"$id":"75462693-0000026"},{"series":6,"level":3,"x1":0.1,"y1":26399.1234568533,"$id":"75462693-0000027"},{"series":6,"level":4,"x1":0.04,"y1":9783.01426377539,"$id":"75462693-0000028"},{"series":6,"level":5,"x1":0.02,"y1":5070.28407793499,"$id":"75462693-0000029"}]},"tolerance_limit":80,"acceptance_limit":20,"acceptance_absolute":false,"quantity_units":null,"rolling_data":false,"rolling_limit":3,"model_to_test":"Linear","correction_allow":false,"correction_threshold":[0.9,1.1],"correction_forced_value":null,"correction_type":"slope","correction_round_to":2,"optimizer_parameter":null,"significant_figure":4,"lod_allowed":null,"lod_force_miller":false,"data_transformation":null,"use_median":false,"status":""}')
    config['data'] = vx.format_json_to_data(config['data'])
    config['correction_type'] = 'average'
    # config['correction_allow'] = True
    # config['correction_forced_value'] = None
    # config['acceptance_absolute'] = True

    profiles = ProfileManager(**config)
    profiles.make_profiles()
    # profiles.optimize()


    aa = profiles.output_profiles()

    for zz in aa.values():
        print(json.dumps({"type": "PROFILE", "data": zz}, cls=PlotlyJSONEncoder))

    profiles.optimize()

    pass

if __name__ == "__main__":
    main()

