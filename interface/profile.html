<script>
    const querystring = require('querystring');
    let query = querystring.parse(global.location.search);
    let processNumber = JSON.parse(query['?processNumber'])
    let profilerName = 'profiler' + processNumber
    const { ipcRenderer } = require('electron');
    const loadBalancer = require('electron-load-balancer');
    const { PythonShell } = require('python-shell')
    const ChildProcess = require('child_process');
    const path = require('path');
    var readline = require('readline');
    var parameters = ['test']
    const executablePath = 'interface//interface.exe'

    let eventType = 'line' //message
    let reader, writer, spawnedProcess

    if (process.env.NODE_ENV === 'production') {
      spawnedProcess = ChildProcess.spawn(executablePath, parameters, {stdio: ['pipe', 'pipe', 'pipe']})
      //This is hacky, to be able to read the buffer by line.
      writer = spawnedProcess.stdin.write.bind(spawnedProcess.stdin)
      reader = new readline.createInterface({
        input: spawnedProcess.stdout,
        terminal: false
      })
      eventType = 'line'
      returnLine = "\n"
    } else {
      spawnedProcess = new PythonShell('interface.py', {
        pythonPath: path.join(process.env["npm_config_prefix"], '\\python'),
        pythonOptions: ['-u'],
        args: parameters
      })
      writer = spawnedProcess.send
      reader = spawnedProcess
      eventType = 'message'
      returnLine = "" //Pyshell already return the line
    }


    loadBalancer.job(
        ipcRenderer,
        profilerName,
        () => {
            loadBalancer.onReceiveData(ipcRenderer, profilerName, args => {
                ipcRenderer.send("GEN_MESSAGE", JSON.stringify(args.data))
                writer(JSON.stringify(args.data) + returnLine);
            });

            reader.on(eventType, function(message) {
                ipcRenderer.send("GEN_MESSAGE", message)
                if (message === "EXIT") {
                    loadBalancer.stop(ipcRenderer, profilerName)
                } else {
                    try {
                        const parsedJSON = JSON.parse(message)
                        switch (parsedJSON['type']) {
                            case 'PROFILE':
                                ipcRenderer.send("PROFILE", {
                                    profiler: profilerName,
                                    data: parsedJSON['data']
                                })
                                break
                        }
                    } catch (e) {
                        ipcRenderer.send("PROFILER_WORKER_ERROR", profilerName)
                        console.log(e)
                        console.log(message)
                        spawnedProcess.terminate()
                    }
                }
            })
        },
        () => {
            spawnedProcess.terminate()
        });

        ipcRenderer.send('PROFILER_WORKER_INIT', profilerName)

</script>